
---

## 第3章 系统设计与规划（Design）

> 本章依据你给出的“人员绩效管理系统”需求文档重写：以**指标库 → 考核周期 → 个人/部门方案 → 绩效评价 → 进度看板 → 考核结果**为主线，从业务口径、角色矩阵、数据/状态模型到 API 顶层设计与非功能约束，形成可被 AI 与人协同理解的一致蓝图。

### 3.0 设计目标与原则

* **目标**：在若依前后端分离框架上，构建覆盖指标、周期、方案、评价、进度、结果的闭环绩效系统，支持可审计、可追溯、可扩展。
* **AI 可读**：所有对象、状态、边界条件以**字典/枚举**和**状态机**方式显式化，便于用 Cursor 等生成代码与测试。
* **一致性**：接口命名、权限码前缀、审计字段、数据范围与若依保持一致。
* **安全合规**：最小权限、可见性控制、日志留痕、敏感数据脱敏与签字确认。

---

### 3.1 业务范围与流程地图

* 覆盖功能：**指标库、考核周期、个人/部门考核方案、绩效评价、进度跟踪（看板）、考核结果（汇总/签字）**。
* 端到端流程：

    1. 指标沉淀（分类、属性、适用部门） →
    2. 周期设定（类型/时间/权重） →
    3. 方案制定与审批（人/部门；覆盖说明与分值；关系与权重） →
    4. 任务生成（按方案项×评价关系） →
    5. 评分与提交（唯一性） →
    6. 汇总计算（关系权重/项权重/周期权重） →
    7. 结果查看/导出/签字确认 →
    8. 过程与结果分析（看板/统计）。

---

### 3.2 角色与职责矩阵（RACI）

* **管理员/HR**：配置指标分类与指标、创建周期与权重、审核方案、监控进度与导出结果（R/A）。
* **部门负责人/分管领导**：制定或审核本部门/条线方案、参与评价与校准（R）。
* **直属上级/互评人**：执行评价任务（R）。
* **员工/中层被考核对象**：制定个人方案、提交材料、自评、查看并签字确认结果（R）。

> 数据可见性：遵循若依数据范围（本部门/本公司/自定义），并按对象（人/部门）与结果状态（是否签字）进行限制。

---

### 3.3 领域模型与 ER 概览

**分类与指标**

* `kpi_indicator_category` 1—N `kpi_indicator`
* `kpi_indicator` N—N `sys_dept`（经 `kpi_indicator_dept` 表）

**周期与配置**

* `kpi_cycle` 1—N `kpi_cycle_weight`（按主体类型与岗位分配评分权重）

**方案（个人/部门）**

* 个人：`kpi_person_plan` 1—N `kpi_person_plan_item`，`kpi_person_plan` 1—N `kpi_person_plan_rater`
* 部门：`kpi_dept_plan` 1—N `kpi_dept_plan_item`，`kpi_dept_plan` 1—N `kpi_dept_plan_rater`

**评价与结果**

* 方案项 → 生成 `kpi_eval_task`（按评价关系/职位/人员） → `kpi_score`（1:1）
* 方案 → 汇总 `kpi_result` 与 `kpi_result_item` → 结果确认 `kpi_result_sign`

> 详细字段见第4章与表设计说明；本章聚焦**关系与口径**一致性。

---

### 3.4 关键对象与属性口径

* **指标（`kpi_indicator`）**：年、种类（dept/person/middle）、分类、适用部门、名称、说明、评分标准、来源、满分；允许被方案**覆盖说明与分值**。
* **周期（`kpi_cycle`）**：类型（quarter/half/year/custom）、年度、起止时间、状态；权重配置在 `kpi_cycle_weight`。
* **方案（人/部门）**：对象（人/部门）、状态（`draft/pending/approved/rejected/active/finished`）、项（可自定义 `item_weight`）、评价关系（评价人/岗位与权重，和=100）。
* **任务与评分**：任务唯一评分（`kpi_score` 与 `task_id` 唯一）；评分含分值与评语。
* **结果**：总分、完成率、状态（`generated/confirmed`）、签字明细。

---

### 3.5 状态机设计

* **周期状态**：`未开始 → 进行中 → 已结束`（或草稿/发布/进行中/结束/归档，落地与字典对齐）。
* **方案状态**：`draft → pending → approved/rejected → active → finished`。
* **任务状态**：`pending → done`（超时标记 `expired`）。
* **结果状态**：`generated → confirmed`（签字完成）。

> 状态迁移需**记录操作者与时间**，关键迁移动作写操作日志；对禁止迁移应返回业务错误码。

---

### 3.6 权重与评分计算口径

* **关系权重**：按 `kpi_person_plan_rater` / `kpi_dept_plan_rater` 对同一 `plan_item` 的多评价人**加权平均**。
* **项权重**：若启用 `item_weight`，各项分按权重求和为方案分；未启用则直接求和/平均（按配置确定）。
* **周期权重**：如定义岗位/主体的周期级权重（`kpi_cycle_weight`），在方案总分上做第二次加权。
* **幂等**：结果可重算（覆盖或版本化）；签字后变更需触发“重签”策略。

---

### 3.7 约束与索引（设计级）

* **唯一性**：`kpi_score(task_id)` 唯一；必要时 `kpi_result(plan_id)` 唯一或引入 `version`。
* **权重合规**：同一方案的评价关系权重和=100（前后端双校验）。
* **软删除**：统一 `del_flag`；被引用记录禁止物理删除。
* **索引建议**：`year`、`category_id`、`kind`、`status`、`cycle_id`、`plan_id`、`rater_user_id`、`target_user_id/target_dept_id`、`kpi_eval_task.status`。

---

### 3.8 接口与资源（API 顶层设计）

* 指标库：`/kpi/indicator/*`、分类 `/kpi/category/*`
* 周期：`/kpi/cycle/*`、权重 `/kpi/cycle/{id}/weights`
* 方案（个人）：`/kpi/person/plan/*`（提交/审批/激活）
* 方案（部门）：`/kpi/dept/plan/*`
* 评价任务与评分：`/kpi/eval/tasks/*`、`/kpi/eval/task/{id}/score`
* 进度看板：`/kpi/progress/*`
* 结果：`/kpi/result/*`（生成/查询/导出/签字）

> 统一遵循 REST 语义；鉴权用 `@PreAuthorize("@ss.hasPermi('kpi:module:op')")`；响应体与分页遵循若依规范。

---

### 3.9 前端信息架构（IA）与导航

* 顶级菜单「绩效管理」：

    * 指标库（分类树 + 指标表格）
    * 考核周期（含权重配置）
    * 个人方案 / 部门方案（草稿/提交/审批/激活）
    * 评价中心（待我评价 / 历史评价）
    * 进度看板（应评/已评/未评/提醒）
    * 结果中心（个人/部门、导出与签字）

> 前端状态管理：RuoYi-Vue 用 Vuex；Plus 用 Pinia；字典 Hook 统一封装；路由与权限指令与若依一致。

---

### 3.10 与若依集成设计

* **用户、部门、岗位**：复用 `sys_user/sys_dept/sys_post`；选择器组件沿用平台封装。
* **审计字段**：`create_by/create_time/update_by/update_time/remark/del_flag`。
* **字典枚举**：`kpi_kind/kpi_cycle_type/kpi_status/kpi_task_status/kpi_result_status` 写入 `sys_dict`，前端 Tag 渲染状态色。
* **数据范围**：对涉及人/部门对象的查询拼接数据范围条件（AOP 或 Mapper 片段复用）。
* **代码生成**：以 `kpi_` 前缀建表后使用代码生成器产出 CRUD，随后按本章口径适配字段与校验。

---

### 3.11 数据流与领域事件

* **E1**：方案 `approved/active` → 生成 `kpi_eval_task`（含截止时间）。
* **E2**：评分提交 → `kpi_score` 写入与任务 `done`。
* **E3**：周期/方案触发结果重算 → 更新 `kpi_result`/`kpi_result_item`。
* **E4**：结果 `generated` → 通知被考核对象签字；`confirmed` → 归档并限制变更。
* **E5**：定时任务扫描 `pending` 且将到期/逾期的任务 → 发送提醒。

---

### 3.12 数据隐私与合规

* 评分评语对被评价者的可见性与匿名策略（互评匿名、评论者身份脱敏）。
* 结果签字需强认证与时间戳；导出水印与访问审计。
* 导入/导出限速与行数阈值；敏感字段（手机/邮箱等）按数据范围脱敏展示。

---

### 3.13 边界与扩展

* **不含**：通用 BPM 流程编排与复杂会签引擎（按线性审批实现）。
* **可扩展**：岗位族群模板、指标权重智能建议（LLM 辅助但人工确认）、校准会九宫格/箱线图可视化。

---

### 3.14 设计产出物（交付清单）

* ER 图（上述表关系）、状态机图（周期/方案/任务/结果）。
* OpenAPI 3.0 草案（路径/请求响应模型/错误码）。
* 字典初始化 SQL、菜单/权限码 SQL 草案。
* 计算口径白皮书（权重/聚合/幂等策略）。

---

### 3.15 本章 Lab（更新）

* **Lab-4A：BPMN → 状态机**：用提示词让 AI 把泳道图转为 4 类状态机与迁移表，并输出守卫条件与审计字段要求。
* **Lab-4B：ER → SQL + OpenAPI**：根据本章 ER，生成建表 SQL 与 OpenAPI 草案；检查枚举/索引/唯一约束。
* **Lab-4C：权限与数据范围**：让 AI 产出各资源的权限码清单与数据范围拼接切面，并生成 3 条典型用例（跨部门访问被拒、HR 全量、员工仅自查）。

---
