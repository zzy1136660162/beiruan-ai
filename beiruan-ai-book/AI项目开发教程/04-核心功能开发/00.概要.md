

## 第4章 核心功能开发（Development）

> 本章依据“人员绩效管理系统”详细需求进行重写，围绕 **指标库 → 考核周期 → 个人/部门考核方案 → 绩效评价 → 进度跟踪 → 考核结果** 的主流程展开，实现口径与数据模型与前后端联动的落地指南。

### 4.0 背景与目标

* 在若依前后端分离框架基础上，建设“人员绩效管理系统”。
* 覆盖 **指标库、考核周期、个人/部门考核方案、绩效评价、进度跟踪、考核结果** 等全流程，保证可审计、可回溯、可扩展。

---

### 4.1 角色与对象

* 角色示例：员工、直属上级、部门负责人、分管领导、HR、管理员。
* 对象：个人（员工/中层）、部门。
* 集成：用户/部门/岗位复用 `sys_user`、`sys_dept`、`sys_post`；统一鉴权与数据范围沿用若依。

---

### 4.2 数据模型与关系（ER 概览）

* **分类与指标**：`kpi_indicator_category` 1—N `kpi_indicator`，`kpi_indicator` N—N `sys_dept`（经 `kpi_indicator_dept`）。
* **周期与配置**：`kpi_cycle` 1—N `kpi_cycle_weight`（不同主体/岗位的评分权重）。
* **方案（人/部门）**：

    * 个人：`kpi_person_plan` 1—N `kpi_person_plan_item`；`kpi_person_plan` 1—N `kpi_person_plan_rater`。
    * 部门：`kpi_dept_plan` 1—N `kpi_dept_plan_item`；`kpi_dept_plan` 1—N `kpi_dept_plan_rater`。
* **评价与结果**：方案项 → 生成 `kpi_eval_task`（按评价关系/职位/人员）；`kpi_eval_task` 1—1 `kpi_score`；方案汇总到 `kpi_result` 与 `kpi_result_item`；结果确认 `kpi_result_sign`。

> 提示：枚举、字典与唯一性约束见 4.9 与 4.10；计算流程见 4.8。

---

### 4.3 字典与枚举（建议写入 `sys_dict`）

* `kpi_kind`：`dept/department`、`person/employee`、`middle/leader`。
* `kpi_cycle_type`：`quarter/half/year/custom`。
* `kpi_status`（方案状态）：`draft/pending/approved/rejected/active/finished`。
* `kpi_task_status`：`pending/done/expired`。
* `kpi_result_status`：`generated/confirmed`。

> AI 生成字典初始化 SQL，并在前端封装字典 Hook：下拉、Tag 渲染、状态色。

---

### 4.4 模块一：指标库

**功能**：指标管理、分类管理、适用部门绑定、查询。

**关键表**：`kpi_indicator_category`、`kpi_indicator`、`kpi_indicator_dept`。

**后端接口示例**

* `GET /kpi/indicator/page`（year/kind/category/keyword 条件查询）
* `POST /kpi/indicator`、`PUT /kpi/indicator/{id}`、`DELETE /kpi/indicator/{id}`
* `GET /kpi/category/tree`、`POST /kpi/category`

**权限码**：`kpi:indicator:list|query|add|edit|remove|export`、`kpi:category:*`

**前端页面**：

* 左侧分类树 + 右侧指标表格；支持“适用部门”多选（`sys_dept` 弹窗选择）。
* 表单字段：`year`、`kind`、`category_id`、`name`、`description`、`scoring_standard`、`source`、`score_full`、`status`、`deptIds[]`。

**验收要点**：

* 同年同分类下指标名可重复与否按业务约束；默认允许重名但不同 `id`。
* 删除限制：被方案引用的指标禁止物理删，走软删 `del_flag='2'` 并提示。

**课堂 Prompt（Cursor）**：

> 依据以下三张表结构，为若依-Plus 生成 Controller/Service/Mapper + Vue3 列表/表单 + 菜单 SQL + 权限码；前端实现分类树筛选与部门弹窗选择；附 E2E 验收用例。

---

### 4.5 模块二：考核周期

**功能**：周期管理、属性维护、评分权重配置、统计。

**关键表**：`kpi_cycle`、`kpi_cycle_weight`。

**后端接口示例**

* `GET /kpi/cycle/page`、`POST /kpi/cycle`、`PUT /kpi/cycle/{id}`、`DELETE /kpi/cycle/{id}`
* `PUT /kpi/cycle/{id}/publish`、`PUT /kpi/cycle/{id}/finish`
* `GET /kpi/cycle/{id}/weights`、`POST /kpi/cycle/{id}/weights`

**权限码**：`kpi:cycle:list|add|edit|remove|publish|finish|weight`

**状态机**：`未开始 → 进行中 → 已结束`（或：草稿/发布/进行中/结束/归档，按实现口径与 4.3 对齐）。

**前端页面**：

* 周期表格（时间、范围、状态）；权重设置弹窗（按 `subject_type` 与 `rater_post_id` 配置权重）。

**验收要点**：

* 权重合规：某周期、某主体类型下 **权重和=100**；保存与发布时校验。
* 发布后的周期禁止更改权重（强约束）；如需更改走“作废重建”。

---

### 4.6 模块三：个人考核方案（员工/中层）

**功能**：方案创建/查看/提交/审核/修改（审核前可改）、被考核人设置、考核关系设置、指标配置、评分权重设置。

**关键表**：`kpi_person_plan`、`kpi_person_plan_item`、`kpi_person_plan_rater`。

**后端接口示例**

* `POST /kpi/person/plan`、`GET /kpi/person/plan/{id}`、`PUT /kpi/person/plan/{id}`
* `POST /kpi/person/plan/{id}/submit`、`PUT /kpi/person/plan/{id}/approve`、`PUT /kpi/person/plan/{id}/reject`
* `GET /kpi/person/plan/{id}/raters`、`POST /kpi/person/plan/{id}/raters`

**权限码**：`kpi:personPlan:*`

**前端页面**：

* 方案编辑页：从指标库选择项，可**覆盖说明与分值**（不影响指标库源数据）。
* 关系配置：按岗位/角色选择考核人并设定权重（合计=100）。

**验收要点**：

* 方案状态：`draft/pending/approved/rejected/active/finished`；仅 `draft` 可编辑。
* 审批流：`submit → pending`，审批通过 `approved`（激活后可生成任务，见 4.8），拒绝回到 `rejected`（可再次修改提交）。

---

### 4.7 模块四：部门考核方案

**功能**：同个人方案，主体为部门；被考核对象为 `target_dept_id`。

**关键表**：`kpi_dept_plan`、`kpi_dept_plan_item`、`kpi_dept_plan_rater`。

**接口/权限/前端**：与 4.6 类似，路由与权限以 `kpi:deptPlan:*` 命名；表单字段与交互一致。

**验收要点**：

* 方案编辑与审批约束同个人方案；支持导入指标项模板以提升效率。

---

### 4.8 模块五：绩效评价

**功能**：

* 待办：显示“待我评价”的任务列表。
* 评分：按任务进入评分页，逐指标给分与评语；展示评分标准。
* 历史：查看我已完成评分与状态。

**关键表**：`kpi_eval_task`、`kpi_score`。

**后端接口示例**

* `GET /kpi/eval/tasks/my`（筛选：周期/对象/状态）
* `GET /kpi/eval/task/{id}`（含指标项、评分标准）
* `POST /kpi/eval/task/{id}/score`（一次性提交评分与评语）

**权限码**：`kpi:eval:list|detail|score`

**约束**：同一 `task_id` 只允许一条 `kpi_score` 记录（唯一键），提交成功则 `task.status=done`，记录 `finish_time`。

**前端页面**：任务列表（标签显示过期/未开始/进行中），评分页（指标 Tabs/列表，校验 0\~满分）。

---

### 4.9 模块六：进度跟踪（工作看板）

**功能**：

* 方案进度：应评/已评/未评/完成比例；按人/部门/周期维度统计。
* 提醒：对未评价人员进行消息提醒（站内信/邮件/企微）。
* 分析：按时间、角色、部门维度出图表。

**实现要点**：

* 汇总查询以 `kpi_eval_task`、`kpi_score` 为主，JOIN 方案、用户/部门表。
* 提醒任务可用定时任务（Quartz）扫描即将到期/已逾期任务，写入若依通知通道。

**后端接口示例**

* `GET /kpi/progress/overview?cycleId=...`（整体）
* `GET /kpi/progress/by-dept`、`GET /kpi/progress/by-user`
* `POST /kpi/progress/remind`（按筛选条件批量提醒）

**权限码**：`kpi:progress:overview|remind`

---

### 4.10 模块七：考核结果（汇总统计）

**功能**：

* 查看最终得分（个人/部门）、评分过程详情、导出（全量/单人）、结果分析（平均/最高/最低）、结果确认（签字）。

**关键表**：`kpi_result`、`kpi_result_item`、`kpi_result_sign`。

**计算口径（与 4.8 流程联动）**：

* 单任务得分：按评分表 `kpi_score.score`。
* 方案-维度分：聚合同一 `plan_item_id` 下不同评分关系的得分，使用 `kpi_person_plan_rater`/`kpi_dept_plan_rater` 的**关系权重**求加权平均。
* 方案总分：对所有 `plan_item` 分进行求和（若 `item_weight` 启用则按权重求和）。
* 周期权重：如需叠加岗位/主体在 `kpi_cycle_weight` 的权重，按设定再进行一次加权。

**后端接口示例**

* `POST /kpi/result/generate?planId=...`（或按周期批量生成）
* `GET /kpi/result/{id}`、`GET /kpi/result/{id}/items`
* `POST /kpi/result/{id}/export`（Excel/PDF）
* `POST /kpi/result/{id}/sign`（签字确认）

**权限码**：`kpi:result:generate|query|export|sign`

**验收要点**：

* 结果生成具幂等性（可重跑覆盖或使用版本号）；签字后禁止变更分值（或触发重签流程）。

---

### 4.11 生成/计算流程（端到端）

1. **方案审核通过**：将方案状态置为 `approved`；允许 **激活** → `active`。
2. **生成任务**：按“方案项 × 评价关系”生成 `kpi_eval_task`（含截止时间、评价人/被评价对象/职位）。
3. **评分提交**：写入 `kpi_score`；`task.status=done`，补 `finish_time`。
4. **汇总计算**：根据关系权重、项权重与周期权重生成 `kpi_result` 与 `kpi_result_item`。
5. **结果确认**：目标对象进行电子签字 `kpi_result_sign`；状态更新为 `confirmed`。

---

### 4.12 约束与索引

* 常用索引：`year`、`category_id`、`kind`、`status`、`cycle_id`、`plan_id`、`rater_user_id`、`target_user_id`/`target_dept_id`、`kpi_eval_task.status`。
* 唯一性：`kpi_score(task_id)` 唯一；必要时对 `kpi_result(plan_id)` 做唯一，或加版本字段。
* 权重合规：同一方案 `rater` 权重之和=100（后端与前端双重校验）。
* 软删除：统一 `del_flag='0'` 生效、`'2'` 删除；被引用数据禁止物理删除。

---

### 4.13 与若依集成与实现要点

* **鉴权**：权限标识按模块前缀（如 `kpi:indicator:*`），`@PreAuthorize("@ss.hasPermi('kpi:...')")`。
* **审计字段**：遵循若依基类字段：`create_by/create_time/update_by/update_time/remark/del_flag`。
* **代码生成**：以 `kpi_` 前缀创建表后，使用代码生成器出 CRUD，再按本文档适配字段与校验逻辑。
* **数据范围**：人/部门对象接口均需拼接数据范围条件；建议封装 AOP 或 Mapper 片段统一复用。
* **导入导出**：统一 `@Excel` 注解；大表导出走分页/流式。

---

### 4.14 测试用例与课堂 Lab（更新）

* **Lab-5 指标库**：完成分类树 + 指标 CRUD + 适用部门绑定与导出。
* **Lab-6 考核周期**：实现权重配置与发布/结束流转，校验权重=100。
* **Lab-7 个人方案**：从指标库挑选并覆盖说明与分值，配置考核关系与权重，提交/审批。
* **Lab-8 部门方案**：同上，主体为部门；支持模板导入。
* **Lab-9 评价任务**：生成任务、完成“待我评价”、提交评分并校验唯一性。
* **Lab-10 进度看板**：实现应评/已评/未评统计与逾期提醒接口。
* **Lab-11 结果汇总**：按关系权重与项权重计算最终分，支持导出与签字确认。

> 每个 Lab 要求：接口 Swagger/Knife4j 可调通；前端页面可操作；SQL/校验/权限/日志齐全；附最小单测（Service/计算器）。

---
